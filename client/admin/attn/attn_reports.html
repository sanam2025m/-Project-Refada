<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªÙ‚Ø±ÙŠØ± Ø³Ù†Ø§Ù… Ø§Ù„Ø£Ù…Ù† â€” Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <style>
:root{
  --brand:#4d2c12; --ink:#000; --muted:#ccc; --paper:#fff; --field:#fdf4e8;
  --page-padding:20mm; --rows-per-page:40;
}

html,body{
  margin:0; padding:0; height:100%;
  background:var(--paper); color:var(--ink);
  font-family:'Cairo',sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  -webkit-print-color-adjust:exact; print-color-adjust:exact;
}

.app{min-height:100vh; display:flex; flex-direction:column;}
.toolbar{
  position:sticky; top:0; z-index:1000;
  display:flex; justify-content:center; gap:12px; padding:12px;
  background:linear-gradient(to bottom, rgba(0,0,0,.04), rgba(0,0,0,0));
  backdrop-filter:blur(4px);
}
.toolbar button{
  padding:10px 20px; font-size:16px; background:var(--brand); color:#fff;
  border:0; border-radius:10px; cursor:pointer;
}

.content{width:min(1200px,100%); margin:0 auto; padding:16px; box-sizing:border-box;}
.card{background:#fff; border:1px solid var(--muted); border-radius:14px; box-shadow:0 4px 20px rgba(0,0,0,.04); padding:18px; margin-bottom:16px;}
.header{display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:10px;}
.header img{height:90px;}
h1,h2{text-align:center; color:var(--brand); margin:8px 0;}
.input-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px 16px; align-items:end;}
.input-line label{font-weight:700; display:block; margin-bottom:4px;}

/* fields */
input[type="text"],input[type="date"]{
  width:100%; border:1px solid #ddd; background:var(--field); font-size:16px;
  padding:8px 10px; border-radius:10px; box-sizing:border-box;
  transition:all .2s ease-in-out;
}

/* ğŸ”» added for dropdown */
select,
.site-select{
  width:100%;
  border:1px solid #ddd;
  background:var(--field);
  font-size:16px;
  padding:8px 36px 8px 12px; /* room for RTL arrow on the left */
  border-radius:10px;
  box-sizing:border-box;
  font-family:'Cairo',sans-serif;
  transition:all .2s ease-in-out;

  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='gray'%3E%3Cpath d='M7 10l5 5 5-5'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-size:14px;
  background-position:left 10px center; /* RTL: arrow on the left */
  cursor:pointer;
}

/* hovers/focus */
input[type="text"]:hover, input[type="date"]:hover,
select:hover, .site-select:hover{
  border-color:#b88c5d;
  background-color:#fff7f0;
}
input[type="text"]:focus, input[type="date"]:focus,
select:focus, .site-select:focus{
  border-color:var(--brand);
  background-color:#fff;
  outline:none;
  box-shadow:0 0 0 3px rgba(77,44,18,0.15);
}

.cover-config textarea{
  width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; background:#fdf4e8;
  font-size:14px; line-height:1.8; resize:vertical;
}
.muted{color:#666;}
.print-only{display:none;}

table{width:100%; border-collapse:collapse; table-layout:fixed;}
th,td{border:1px solid #ddd; padding:6px; text-align:center; font-size:12px; word-break:break-word; white-space:pre-wrap;}

/* ===================== Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ===================== */
@page { size: A4; margin: 0; }

@media print{
  html, body{
    margin:0 !important; width:210mm; height:291mm; overflow:visible;
  }

  thead th{
    background:#CC9D79 !important; color:#fff !important;
    -webkit-print-color-adjust:exact; print-color-adjust:exact;
  }

  .toolbar, .card.screen-only, .screen-only{ display:none !important; }
  .print-only{ display:block !important; }

  .print-page{
    display:block; position:relative; box-sizing:border-box;
    width:210mm; height:291mm; margin:0 auto; padding:0; overflow:hidden; background:#fff;
    break-after:auto; page-break-after:auto;
  }

  .print-page:nth-child(n+3){ break-before:page; page-break-before:always; }

  .print-page .page-content{
    padding:var(--page-padding); box-sizing:border-box; width:100%; max-width:100%; overflow-x:hidden;
  }

  table{ width:100%; border-collapse:collapse; table-layout:fixed; page-break-inside:auto; break-inside:auto; }
  thead{ display:table-header-group !important; }
  tfoot{ display:table-footer-group !important; }
  tbody{ display:table-row-group; }
  th, td{ font-size:12px; border:1px solid #ccc; page-break-inside:avoid; break-inside:avoid; }
  img{ max-width:100%; height:auto; }

  .cover-page, .second-page{ position:relative; height:291mm; overflow:hidden; background:none !important; }
  .cover-page::before{
    content:""; position:absolute; inset:0; height:calc(100% - 0.2mm); width:calc(100% - 0.2mm);
    background-image:url('cover-page1.png');
    background-repeat:no-repeat; background-position:center center; background-size:210mm 288mm; pointer-events:none;
  }
  #printRoot > .print-page:nth-child(2){ background-color:#fdf4e8 !important; }
  #printRoot > .print-page:nth-child(n+3){ background-color:#fdf4e8 !important; }
  #printRoot > .print-page:nth-child(n+3)::after{
    content:""; position:absolute; top:10mm; right:var(--page-padding); width:45mm; height:28mm;
    background:url('logo_sanam.png') no-repeat center / contain;
  }
  #printRoot > .print-page:nth-child(n+3) .page-content{ padding-top:calc(var(--page-padding) + 18mm); }

  .table-page .page-content{ padding-bottom:calc(var(--page-padding) + 20mm); }
  #printRoot > .print-page.table-page .page-content > h2{ margin:var(--page-padding) var(--page-padding) 6mm; }

  /* ğŸ‘‡ Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø· (1ØŒ7ØŒ8ØŒ10ØŒ11ØŒ12) */
  .attendance-table thead th:nth-child(1),
  .attendance-table tbody td:nth-child(1),
  .attendance-table thead th:nth-child(7),
  .attendance-table tbody td:nth-child(7),
  .attendance-table thead th:nth-child(8),
  .attendance-table tbody td:nth-child(8),
  .attendance-table thead th:nth-child(10),
  .attendance-table tbody td:nth-child(10),
  .attendance-table thead th:nth-child(11),
  .attendance-table tbody td:nth-child(11),
  .attendance-table thead th:nth-child(12),
  .attendance-table tbody td:nth-child(12){
    display:none !important;
  }
}


/* ====== ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙƒÙ…Ø§ Ø·ÙÙ„Ø¨ + ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù…Ù‚Ø§Ø³ ====== */
@media (min-width: 1024px){
  .input-grid{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px 16px;
    grid-template-areas:
      "subject to from date"
      "employee site company pages";
  }
  .f-date{grid-area:date}
  .f-from{grid-area:from}
  .f-to{grid-area:to}
  .f-subject{grid-area:subject}
  .f-pages{grid-area:pages}
  .f-company{grid-area:company}
  .f-site{grid-area:site}
  .f-employee{grid-area:employee}
}
@media (max-width: 1023px){
  .input-grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(240px,1fr));
    gap: 12px 16px;
  }
}
/* ØªÙˆØ­ÙŠØ¯ Ù…Ù‚Ø§Ø³ Ø§Ù„Ø­Ù‚ÙˆÙ„ */
.input-line { display:flex; flex-direction:column; }
.input-line input, .input-line select, .input-line textarea {
  width: 100%; min-height: 56px; padding: 10px 14px; border-radius: 14px;
  border: 1px solid #ddd; background: #fdf4e8; font-size: 16px; box-sizing: border-box;
}
.input-line textarea { min-height: 120px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="toolbar screen-only">
      <button id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF</button>
    </div>

    <div class="content">
      <section class="card screen-only">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØºÙ„Ø§Ù</h2>
        <div class="cover-config">
          <label>Ù†Øµ Ø¹Ù„Ù‰ Ø§Ù„ØºÙ„Ø§Ù:</label>
          <textarea id="coverText" rows="2" placeholder="ØªÙ… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙˆØ§Ø³Ø·Ø© â€¦&#10;(Ø§ÙƒØªØ¨ Ø³Ø·Ø±Ù‹Ø§ Ø«Ø§Ù†ÙŠÙ‹Ø§ Ù‡Ù†Ø§)"></textarea>
          <small class="muted">Ù„Ù† ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©ØŒ Ø¨Ù„ Ø³ÙŠÙØ·Ø¨Ø¹ Ø§Ù„Ù†Øµ Ù…ÙƒØ§Ù†Ù‡ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù.</small>
        </div>
      </section>

      <section class="card screen-only">
        <div class="header">
          <img src="assets/logo_sanam.png" alt="Ø´Ø¹Ø§Ø± Ø³Ù†Ø§Ù… Ø§Ù„Ø£Ù…Ù†" style="height:85px;" />
          <img src="assets/logo_rajhi.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ" />
        </div>
        <h1>ØªÙ‚Ø±ÙŠØ± Ø³Ù†Ø§Ù… Ø§Ù„Ø§Ù…Ù†</h1>

        <div class="input-grid">
          <div class="input-line f-subject">
            <label>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
            <input type="text" id="subject" />
          </div>
          <div class="input-line f-to">
            <label>Ø¥Ù„Ù‰</label>
            <input type="date" id="to" />
          </div>
          <div class="input-line f-from">
            <label>Ù…Ù†</label>
            <input type="date" id="from" />
          </div>
          <div class="input-line f-date">
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input type="text" id="date" />
          </div>
          <div class="input-line f-employee">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <select id="employeeFilter">
              <option value="">Ø§Ù„ÙƒÙ„</option>
            </select>
          </div>
          <div class="input-line f-site">
            <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
            <select id="site">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="Ø§Ù„Ù†Ø³ÙŠÙ… 1">Ø§Ù„Ù†Ø³ÙŠÙ… 1</option>
              <option value="Ø§Ù„Ù†Ø³ÙŠÙ… 4">Ø§Ù„Ù†Ø³ÙŠÙ… 4</option>
            </select>
          </div>
          <div class="input-line f-company">
            <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input type="text" id="company" />
          </div>
          <div class="input-line f-pages">
            <label>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª (ØªÙ‚Ø¯ÙŠØ±ÙŠ)</label>
            <input type="text" id="pages" />
          </div>
        </div>

        <section class="card screen-only">
          <h2>Ù†Øµ Ø§Ù„Ø®Ø·Ø§Ø¨</h2>
          <p class="muted">Ø§Ø³ØªØ®Ø¯Ù… {from} Ùˆ {to} Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ù…Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.</p>

          <label class="input-line" style="display:block; margin-bottom:8px;"><strong>Ø§Ù„Ù†Øµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</strong></label>
          <textarea id="letterBody" rows="8">
Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ØŒ 
Ù†Ù‚Ø¯Ù‘Ù… Ù„Ø³Ø§Ø¯ØªÙƒÙ… Ù‡Ø°Ø§ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø£Ù†ØµØ±Ø§Ù Ù„Ù„ÙØªØ±Ø© Ù…Ù† {from} Ø¥Ù„Ù‰ {to}ØŒ ÙˆØ§Ù„Ù…ØªØ¹Ù„Ù‚ Ø¨ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù†Ø¸Ø§ÙØ© ÙÙŠ Ù…ÙˆÙ‚Ø¹ {Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£Ù‡Ù„Ø© Ù…ÙˆÙ„}ØŒ ÙˆÙÙ‚Ø§Ù‹ Ù„Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø¨Ø±Ù… Ù…Ø¹ Ø´Ø±ÙƒØªÙƒÙ… Ø§Ù„Ù…ÙˆÙ‚Ø±Ø©.
ÙŠØªØ¶Ù…Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®ØµØ§Ù‹ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù ØŒ ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ØŒ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø©ØŒ Ø¥Ù„Ù‰ Ø¬Ø§Ù†Ø¨ Ø§Ù„ØªÙˆØµÙŠØ§Øª ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ù„ØªØ¹Ø²ÙŠØ² Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ø¸Ø§ÙØ© 
Ù†Ø³Ø¹Ø¯ Ø¨Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙ…Ø± Ù…Ø¹ÙƒÙ…ØŒ ÙˆÙ†Ø¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù„Ù‰ ØªÙ‚Ø¯ÙŠÙ… Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ÙƒÙØ§Ø¡Ø© ÙˆØ§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© Ù„Ø®Ø¯Ù…Ø© Ù…Ù†Ø´Ø£ØªÙƒÙ….
Ø±Ø§Ø¬ÙŠÙ† Ø£Ù† ÙŠÙ†Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø±Ø¶Ø§ÙƒÙ…ØŒ ÙˆÙ…Ø³ØªØ¹Ø¯ÙˆÙ† Ù„ØªÙ‚Ø¯ÙŠÙ… Ø£ÙŠ ØªÙˆØ¶ÙŠØ­Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø­Ø§Ù„ ØªØ·Ù„Ø¨ Ø§Ù„Ø£Ù…Ø±.</textarea>

          <div class="input-line" style="margin-top:10px;">
            <label><strong>Ø³Ø·Ø± Ø§Ù„Ø´ÙƒØ± (Ø³Ø·Ø± ÙˆØ§Ø­Ø¯)</strong></label>
            <input type="text" id="thanksLine" value="ØªÙØ¶Ù„ÙˆØ§ Ø¨Ù‚Ø¨ÙˆÙ„ ÙØ§Ø¦Ù‚ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±" />
          </div>

          <div class="input-line" style="margin-top:10px;">
            <label><strong>ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø®Ø·Ø§Ø¨</strong> <small class="muted">(ÙƒÙ„ Ø³Ø·Ø± ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„)</small></label>
            <textarea id="footerBlock" rows="3">ÙØ±ÙŠÙ‚ Ø´Ø±ÙƒØ© Ø³Ù†Ø§Ù… Ø§Ù„Ø£Ù…Ù†
Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©</textarea>
          </div>
        </section>
      </section>

      <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù -->
      <section class="card screen-only">
        <div id="attendancePreview"><!-- table injected --></div>
      </section>

      <!-- ØµÙØ­Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
      <div id="printRoot" class="print-only"></div>
    </div>
  </div>

  <script>
/* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===== */
const apiKey = "AIzaSyBYPUAnYE8GC4Vx32cDYSb8UH6YV-VWmEA";
const fields = ["date","from","to","subject","pages","company","site","coverText","letterBody","thanksLine","footerBlock"];

/* ===== Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Google Sheets (Ø§Ù„Ø­Ø¶ÙˆØ±) ===== */
async function fetchSheetData(sheetId, range){
  try{
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(range)}?key=${apiKey}`;
    const res = await fetch(url);
    const data = await res.json();
    return data.values && data.values.length ? data.values : [["Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª"]];
  }catch(e){
    return [["Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„"]];
  }
}

/* ===== Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® ===== */
function parseDateCell(v){
  const m=(v||'').match(/\d{4}[-\/]\d{2}[-\/]\d{2}|\d{2}[-\/]\d{2}[-\/]\d{4}/);
  return m ? new Date(m[0].replace(/-/g,'/')) : null;
}
function filterByDateRange(data, fromDateStr, toDateStr, colIndex=0){
  const f=new Date(fromDateStr), t=new Date(toDateStr);
  if(isNaN(f)||isNaN(t)) return data;
  return data.filter((row,idx)=>{
    if(idx===0) return true;
    const d=parseDateCell(row[colIndex]||"");
    return d && d>=f && d<=t;
  });
}

/* ===== ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ (ÙŠØ¯Ø¹Ù… Ù†Øµ/Dropdown) ===== */
function normalizeSite(s){
  if (s == null) return '';
  const arabicDigits = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
  const replaced = String(s).replace(/[Ù -Ù©]/g, d => arabicDigits[d] || d);
  return replaced.trim().replace(/\s+/g,' ').toLowerCase();
}
// Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ = E (index 4) â€” Ø¹Ø¯Ù‘Ù„ Ù„Ùˆ Ù…Ø®ØªÙ„Ù
function filterBySiteFixedColumn(data, siteName, colIndex=4){
  if (!siteName) return data;
  if (!data || !data.length) return data;
  const wanted = normalizeSite(siteName);
  return data.filter((row, r) => {
    if (r === 0) return true;
    const cell = normalizeSite(row[colIndex] ?? '');
    return cell === wanted;
  });
}


/* ===== Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ±ÙŠØ¯Ø© ===== */
function findNameColumn(headers){
  // ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "Ø§Ù„Ø§Ø³Ù…" Ø£Ùˆ "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù" Ø£Ùˆ "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ"
  const patterns = [/\bØ§Ù„Ø§Ø³Ù…\b/i,/Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù/i,/Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ/i];
  for (let i=0;i<headers.length;i++){
    const h = String(headers[i]||'').trim();
    if (patterns.some(re => re.test(h))) return i;
  }
  // Ø§ÙØªØ±Ø§Ø¶ÙŠ: B (index 1) Ø¥Ù† Ù„Ù… Ù†Ø¬Ø¯
  return 1;
}
function uniqueEmployeeNames(values){
  if (!values || values.length<2) return [];
  const headers = values[0];
  const nameIdx = findNameColumn(headers);
  const set = new Set();
  for (let r=1;r<values.length;r++){
    const name = String((values[r]||[])[nameIdx]||'').trim();
    if (name) set.add(name);
  }
  return Array.from(set).sort((a,b)=>a.localeCompare(b,'ar'));
}
function filterByEmployeeName(values, selectedName){
  if (!selectedName) return values;
  if (!values || values.length<2) return values;
  const headers = values[0];
  const nameIdx = findNameColumn(headers);
  const result = [headers];
  for (let r=1;r<values.length;r++){
    const row = values[r]||[];
    if (String(row[nameIdx]||'').trim() === selectedName) result.push(row);
  }
  return result;
}
function populateEmployeeFilter(values){
  const sel = document.getElementById('employeeFilter');
  if (!sel) return;
  const chosen = sel.value;
  const names = uniqueEmployeeNames(values);
  sel.innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>' + names.map(n=>`<option value="${n}">${n}</option>`).join('');
  // Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ù…Ø®ØªØ§Ø± Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ù…Ø§Ø²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø§Ø­ØªÙØ¸ Ø¨Ù‡
  if (chosen && names.includes(chosen)) sel.value = chosen;
}
/* ===== ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ø¥Ù„Ù‰ 12 Ø³Ø§Ø¹Ø© (Øµ/Ù…) Ø¯Ø§Ø®Ù„ Ø£ÙŠ Ù†Øµ ===== */
function convertTimesInText(text){
  if (text == null) return text;
  let s = String(text);
  const hasAmPm = /\b(AM|PM|am|pm|Øµ|Ù…)\b/.test(s);
  const re = /(\b[01]?\d|2[0-3]):([0-5]\d)(?::([0-5]\d))?/g;
  return s.replace(re, (full, hh, mm, ss) => {
    if (hasAmPm) return full;
    const h = parseInt(hh,10);
    const period = (h < 12) ? 'Øµ' : 'Ù…';
    let h12 = h % 12; if (h12 === 0) h12 = 12;
    return `${h12}:${mm}${ss ? ':'+ss : ''} ${period}`;
  });
}

/* ===== Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„: padding Ù„Ù„ØµÙ + "O" Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© 9/10 + ØªØ­ÙˆÙŠÙ„ 12 Ø³Ø§Ø¹Ø© ===== */
function buildTableHTML(values, className){
  if (!values || !values.length) return '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
  const headers = values[0];
  const cls = className ? ` class="${className}"` : '';
  let h = `<table${cls}><thead><tr>` +
          headers.map(h => `<th>${h}</th>`).join('') +
          `</tr></thead><tbody>`;

  for (let i = 1; i < values.length; i++) {
    const row = values[i] || [];
    // Ù…Ù‡Ù…: padding Ù„Ø·ÙˆÙ„ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù„Ø£Ù† Google Sheets Ù‚Ø¯ ÙŠØ­Ø°Ù Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØ§Ø±ØºØ©
    const rowPadded = Array.from({length: headers.length}, (_, j) => row[j] ?? '');

    h += '<tr>' + rowPadded.map((cell, colIdx) => {
      let val = (cell == null || String(cell).trim() === '') ? '' : String(cell).trim();

      // Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© 9 Ùˆ10 (index 8,9) â†’ "O" Ø¥Ø°Ø§ ÙØ§Ø¶ÙŠØ© (Ù„Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰)
      if (className === 'attendance-table' && (colIdx === 8 || colIdx === 9)) {
        if (!val) val = 'O';
      }

      // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ù„Ùˆ Ù…Ø§ Ø²Ø§Ù„Øª ÙØ§Ø¶ÙŠØ© â†’ '-'
      if (!val) return `<td>-</td>`;

      // ØªØ­ÙˆÙŠÙ„ Ø£ÙˆÙ‚Ø§Øª 24h Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ 12h (Øµ/Ù…)
      const shown = convertTimesInText(val);
      return `<td>${shown}</td>`;
    }).join('') + '</tr>';
  }

  h += '</tbody></table>';
  return h;
}

/* ===== Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© ===== */
function updateDocumentTitleWithDateRange(){
  const f=document.getElementById('from').value;
  const t=document.getElementById('to').value;
  const s=document.getElementById('subject').value||'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù';
  document.title=(f&&t)?`${s} - Ù…Ù† ${f} Ø¥Ù„Ù‰ ${t}`:s;
}

/* ===== Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¹Ø±Ø¶ ===== */
async function loadAndRender(){
  const fromDate=document.getElementById('from').value;
  const toDate  =document.getElementById('to').value;
  const siteVal = document.getElementById('site')?.value || '';

  const raw = await fetchSheetData('1LMeDt4PSeUBUA1IFhBoHSIgnTK-XzLcxIbN4hT6Y7fc','Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!A2:L');

  // 1) ÙÙ„ØªØ±Ø© ØªØ§Ø±ÙŠØ®
  const dated = (fromDate&&toDate)?filterByDateRange(raw,fromDate,toDate,0):raw;

  // 2) ÙÙ„ØªØ±Ø© Ù…ÙˆÙ‚Ø¹ (Ø§Ù„Ø¹Ù…ÙˆØ¯ E = index 4 Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹)
  const bySite = filterBySiteFixedColumn(dated, siteVal, 4);

  // 2.5) Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  populateEmployeeFilter(bySite);

  // 2.6) ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù (Ø¥Ù† Ø§Ø®ØªÙŠØ±)
  const employeeName = document.getElementById('employeeFilter')?.value || '';
  const byEmployee = filterByEmployeeName(bySite, employeeName);

  // 3) Ø§Ù„Ø¹Ø±Ø¶
  document.getElementById('attendancePreview').innerHTML = buildTableHTML(byEmployee, 'attendance-table');

  // 4) Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
  buildPrintPages(byEmployee);
  updatePagesFieldFromDOM();
  syncPrintFields();
}

/* ===== Ø¹Ø¯Ù‘ Ø§Ù„ØµÙØ­Ø§Øª ===== */
function updatePagesFieldFromDOM(){
  const root  = document.getElementById('printRoot');
  const field = document.getElementById('pages');
  const span  = document.getElementById('print_pages');
  if (!root || !field) return;
  const count = root.querySelectorAll('.print-page').length;
  field.value = count; if (span) span.textContent = count;
}

/* ===== Ø¨Ù†Ø§Ø¡ ØµÙØ­Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø§Ù„ØºÙ„Ø§Ù + Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª + Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯) ===== */
function buildPrintPages(values){
  const root=document.getElementById('printRoot');
  root.innerHTML='';

  const coverTextSaved=document.getElementById('coverText').value||'';

  // Ø§Ù„ØºÙ„Ø§Ù
  const cover=document.createElement('section');
  cover.className='print-page cover-page';
  const cText=document.createElement('div');
  Object.assign(cText.style,{position:'absolute', bottom:'90px', left:'30px', color:'#fff', fontSize:'16px', fontWeight:'700', whiteSpace:'pre-wrap', width:'300px'});
  cText.textContent=coverTextSaved; cover.appendChild(cText); root.appendChild(cover);

  // ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
  const info=document.createElement('section');
  info.className='print-page second-page';
  info.innerHTML=`
    <div class="page-content">
      <div class="header">
         <img src="assets/logo_sanam.png" alt="Ø´Ø¹Ø§Ø± Ø³Ù†Ø§Ù… Ø§Ù„Ø£Ù…Ù†" style="height: 85px;" />
         <img src="assets/logo_rajhi.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ" />
      </div>
      <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù</h1>
      <div style="font-size:14px;line-height:1.8">
        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="print_date"></span></p>
        <p><strong>Ø§Ù„ÙØªØ±Ø©:</strong> Ù…Ù† <span id="print_from"></span> Ø¥Ù„Ù‰ <span id="print_to"></span></p>
        <p><strong>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</strong> <span id="print_subject"></span></p>
        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª:</strong> <span id="print_pages"></span></p>
        <p><strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="print_company"></span></p>
        <p><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> <span id="print_site"></span></p>
        <div id="print_letterBlock" style="margin-top:12px"></div>
      </div>
    </div>`;
  root.appendChild(info);

  // ØµÙØ­Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
  appendPaginatedTableMeasured(root, values, 'Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù', 20, 'attendance-table');
}

/* ===== ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ ØµÙØ­Ø§Øª Ø¨Ø·Ø¨Ø§Ø¹Ø© Ù…Ù‚Ø§Ø³Ø© ===== */
function appendPaginatedTableMeasured(root, values, title, extraBottomMm=20, className){
  const pages = paginateValuesMeasured(values, title, extraBottomMm);

  if (!pages.length) {
    const empty = document.createElement('section');
    empty.className = 'print-page table-page';
    empty.innerHTML = `<div class="page-content"><h2>${title}</h2><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</p></div>`;
    root.appendChild(empty);
    return;
  }

  pages.forEach((vals, idx) => {
    const sec = document.createElement('section');
    sec.className = 'print-page table-page';
    const tableHTML = buildTableHTML(vals, className);
    sec.innerHTML = `<div class="page-content">${idx === 0 ? ('<h2>' + title + '</h2>') : ''}${tableHTML}</div>`;
    root.appendChild(sec);
  });
}
function paginateValuesMeasured(allValues, title, extraBottomMm = 20){
  if (!allValues || !allValues.length) return [];
  const headers = allValues[0];
  const rows = allValues.slice(1);

  const chunks = [];
  let i = 0, firstPage = true;

  while (i < rows.length) {
    const fit = measureRowsFit(headers, rows.slice(i), firstPage, title, extraBottomMm);
    const rowsThisPage = Math.max(1, fit);
    chunks.push([headers, ...rows.slice(i, i + rowsThisPage)]);
    i += rowsThisPage;
    firstPage = false;
  }
  return chunks;
}
function measureRowsFit(headers, candidateRows, includeTitle, title, extraBottomMm){
  const page = document.createElement('div');
  page.style.cssText = `position:absolute; left:-10000px; top:0; width:210mm; height:297mm; box-sizing:border-box; background:#fff; overflow:hidden; font-family:'Cairo', sans-serif;`;

  const pagePaddingStr = getComputedStyle(document.documentElement).getPropertyValue('--page-padding').trim() || '20mm';
  const padMm = parseFloat(pagePaddingStr) || 20;
  const padPx = mm2px(padMm);
  const extraPx = mm2px(extraBottomMm);

  const content = document.createElement('div');
  content.style.cssText = `box-sizing:border-box; width:100%; height:100%; padding:${padPx}px; padding-bottom:${padPx + extraPx}px;`;
  page.appendChild(content);

  if (includeTitle) {
    const h2 = document.createElement('h2');
    h2.style.cssText = `margin:8px 0; text-align:center; font-size:16px;`;
    h2.textContent = title || '';
    content.appendChild(h2);
  }

  const table = document.createElement('table');
  table.style.cssText = 'width:100%; border-collapse:collapse; table-layout:fixed;';
  const thead = document.createElement('thead');
  const hr = document.createElement('tr');
  headers.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h ?? '';
    th.style.cssText = 'border:1px solid #ccc; padding:6px; font-size:12px; word-break:break-word; white-space:pre-wrap;';
    hr.appendChild(th);
  });
  thead.appendChild(hr); table.appendChild(thead);
  const tbody = document.createElement('tbody'); table.appendChild(tbody);
  content.appendChild(table);

  document.body.appendChild(page);

  const safeHeight = page.clientHeight;
  let fit = 0;
  for (let r = 0; r < candidateRows.length; r++) {
    const tr = document.createElement('tr');
    candidateRows[r].forEach(cell => {
      const td = document.createElement('td');
      td.textContent = (cell ?? '').toString();
      td.style.cssText = 'border:1px solid #ccc; padding:6px; font-size:12px; word-break:break-word; white-space:pre-wrap;';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);

    if (page.scrollHeight > safeHeight) { tbody.removeChild(tr); break; } else { fit++; }
  }

  document.body.removeChild(page);
  return fit;
}
function mm2px(mm){ return mm * (96 / 25.4); }

/* ===== Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ ===== */
function syncPrintFields(){
  ['date','from','to','subject','pages','company','site'].forEach(id=>{
    const el=document.getElementById(id);
    const span=document.getElementById('print_'+id);
    if(el && span) span.textContent=el.value||'';
  });

  const out = document.getElementById('print_letterBlock');
  const bodyEl   = document.getElementById('letterBody');
  const thanksEl = document.getElementById('thanksLine');
  const footEl   = document.getElementById('footerBlock');
  if(!out) return;

  const fromVal=document.getElementById('from').value||'____';
  const toVal  =document.getElementById('to').value  ||'____';

  const bodyRaw = (bodyEl?.value || '').replaceAll('{from}', fromVal).replaceAll('{to}', toVal);

  const toParas = (txt, align, bold=false) =>
    (txt || '').split(/\r?\n/).map(line=>{
      const t=line.trim(); if(!t) return `<p dir="rtl">&nbsp;</p>`;
      const alignCss  = align ? `text-align:${align};` : '';
      const weightCss = bold ? 'font-weight:700;' : '';
      return `<p dir="rtl" style="${alignCss}${weightCss}">${t}</p>`;
    }).join('');

  let html = '';
  html += toParas(bodyRaw, '');
  const thanks = (thanksEl?.value || '').trim(); if(thanks){ html += `<p dir="rtl" style="text-align:center;">${thanks}</p>`; }
  const footer = footEl?.value || ''; if(footer){ html += toParas(footer, 'left', true); }
  out.innerHTML = html;
}

/* ===== ØªÙ‡ÙŠØ¦Ø© ===== */
window.addEventListener('load', ()=>{
  fields.forEach(id=>{
    const el=document.getElementById(id);
    const saved=localStorage.getItem('report_attendance_'+id);
    if(saved && el) el.value=saved;
    if(el){
      el.addEventListener('input', ()=>{
        localStorage.setItem('report_attendance_'+id, el.value);
        updateDocumentTitleWithDateRange();
        syncPrintFields();

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø± Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø³ÙˆØ§Ø¡ input Ø£Ùˆ select)
        if (id === 'site') {
          loadAndRender();
        }
      });
      if(id==='from' || id==='to'){
        el.addEventListener('change', ()=>{
          loadAndRender();
          updateDocumentTitleWithDateRange();
        });
      }
    }
  });

  loadAndRender();
  syncPrintFields();
  updateDocumentTitleWithDateRange();
});

/* ===== Ø·Ø¨Ø§Ø¹Ø© ===== */
/* ===== Ø·Ø¨Ø§Ø¹Ø© (Ø¨Ø§ØªØ´ Ù…Ø³ØªÙ‚Ø±) ===== */
function buildPagesFromPreview() {
  const previewTable = document.querySelector('#attendancePreview table');
  const values = previewTable ? tableToValues(previewTable) : [];
  buildPrintPages(values);
  finalizePrintPages();
  updatePagesFieldFromDOM();
  syncPrintFields();
}

// Ù†Ø¹Ø·ÙŠ Ø§Ù„Ù…ØªØµÙØ­ ÙˆÙ‚Øª ÙƒØ§ÙÙŠ Ù„ÙŠØ¹ÙŠØ¯ Ø§Ù„ØªØ¯ÙÙ‚ Ù‚Ø¨Ù„ Ø£Ù…Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
function printAfterLayout() {
  // 1) Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙÙ‚
  document.body.offsetHeight; // reflow

  // 2) Ø¯ÙˆØ±ØªÙŠÙ† RAF + Ù…Ù‡Ù„Ø© Ù‚ØµÙŠØ±Ø© (Ù…ÙˆØ«ÙˆÙ‚ Ø£ÙƒØ«Ø± Ù…Ù† setTimeout ÙˆØ§Ø­Ø¯)
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      setTimeout(() => {
        window.print();
      }, 0);
    });
  });
}

document.getElementById('printBtn').addEventListener('click', () => {
  buildPagesFromPreview();
  printAfterLayout();
});

// ÙÙŠ beforeprint (Ù„Ùˆ ÙØªØ­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­) Ù†Ø¶Ù…Ù† Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙØ­Ø§Øª
window.addEventListener('beforeprint', () => {
  buildPagesFromPreview();
});


/* ===== ØªØ­ÙˆÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¥Ù„Ù‰ values ===== */
function tableToValues(table){
  const values=[];
  const headers=Array.from(table.tHead?.rows?.[0]?.cells||[]).map(th=>th.textContent.trim());
  if(headers.length) values.push(headers);
  const rows=Array.from(table.tBodies?.[0]?.rows||[]);
  rows.forEach(tr=>{ values.push(Array.from(tr.cells).map(td=>td.textContent)); });
  return values;
}

/* ===== ØªÙ†Ø¸ÙŠÙ ØµÙØ­Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ===== */
function finalizePrintPages(){
  const root = document.getElementById('printRoot');
  const pages = Array.from(root.querySelectorAll('.print-page'));
  if (pages.length) { const last = pages[pages.length - 1]; last.style.breakAfter = 'auto'; last.style.pageBreakAfter = 'auto'; }
  pages.forEach(p => {
    const hasContent = p.classList.contains('cover-page') || p.classList.contains('second-page') || p.querySelector('table, img, h1, h2, p, .page-content *');
    if (!hasContent) p.remove();
  });
}



/* ===== Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ===== */
document.addEventListener('change', (e)=>{
  if (e.target && e.target.id === 'employeeFilter'){
    try { loadAndRender(); } catch(_) {}
  }
});

  </script>
</body>
</html>
